---
#
# Check_MK multisite/WATO configuration
#




- name: Generate Check_MK WATO multisite definitions
  template:
    src: '{{ lookup("template_src", "etc/check_mk/multisite.d/wato/" + item | basename) }}'
    dest: '{{ checkmk_server__site_home }}/{{ checkmk_server__multisite_config_path }}/wato/{{ item | basename | replace(".j2", "") }}'
    owner: '{{ checkmk_server__user }}'
    group: '{{ checkmk_server__group }}'
    mode: '{{ "0660"
              if item | basename | replace(".j2", "") in [ "hosttags.mk", "users.mk", "user_connections.mk" ]
              else "0644" }}'
  with_fileglob: [ '../templates/etc/check_mk/multisite.d/wato/*.mk.j2' ]
  notify: [ 'Reload Check_MK configuration' ]
  tags: [ 'role::checkmk_server:rules', 'role::checkmk_server:multisite' ]

- name: Generate Check_MK custom multisite definitions
  template:
    src: 'etc/check_mk/multisite.d/custom.mk.j2'
    dest: '{{ checkmk_server__site_home }}/{{ checkmk_server__multisite_config_path }}/{{ item["filename"] }}'
    owner: '{{ checkmk_server__user }}'
    group: '{{ checkmk_server__group }}'
    mode: '0644'
  with_items: '{{ checkmk_server__multisite_config_map }}'
  when: not item['wato']|d(True)
  notify: [ 'Reload Check_MK configuration' ]
  tags: [ 'role::checkmk_server:rules', 'role::checkmk_server:multisite' ]

- name: Generate Check_MK WATO monitoring definitions
  template:
    src: '{{ lookup("template_src", "etc/check_mk/conf.d/wato/" + item | basename) }}'
    dest: '{{ checkmk_server__site_home }}/{{ checkmk_server__site_config_path }}/wato/{{ item | basename | replace(".j2", "") }}'
    owner: '{{ checkmk_server__user }}'
    group: '{{ checkmk_server__group }}'
    mode: '{{ "0660"
              if item | basename | replace(".j2", "") in [ "contacts.mk" ]
              else "0644" }}'
  with_fileglob: [ '../templates/etc/check_mk/conf.d/wato/*.mk.j2' ]
  notify: [ 'Reload Check_MK configuration' ]
  tags: [ 'role::checkmk_server:rules' ]

- name: Generate Check_MK custom monitoring definitions
  template:
    src: 'etc/check_mk/conf.d/custom.mk.j2'
    dest: '{{ checkmk_server__site_home }}/{{ checkmk_server__site_config_path }}/{{ item["filename"] }}'
    owner: '{{ checkmk_server__user }}'
    group: '{{ checkmk_server__group }}'
    mode: '0644'
  with_items: '{{ checkmk_server__site_config_map }}'
  when: not item['wato']|d(True)
  notify: [ 'Reload Check_MK configuration' ]
  tags: [ 'role::checkmk_server:rules' ]
